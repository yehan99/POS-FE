<ng-container *ngIf="customer && !isLoading; else customerLoading">
  <section class="customer-detail">
    <header class="page-header">
      <div class="page-header__title">
        <button mat-icon-button (click)="goBack()" class="ghost-button" matTooltip="Back to customers">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div>
          <p class="eyebrow">Sales &amp; CRM</p>
          <h1>{{ customer.firstName }} {{ customer.lastName }}</h1>
          <p class="subtitle">Customer code <strong>{{ customer.customerCode }}</strong></p>
        </div>
      </div>
      <div class="page-header__actions">
        <button mat-stroked-button type="button" (click)="editCustomer()">
          <mat-icon>edit</mat-icon>
          Edit
        </button>
        <button mat-icon-button [matMenuTriggerFor]="menu">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #menu="matMenu">
          <button mat-menu-item (click)="deleteCustomer()" class="danger">
            <mat-icon>delete</mat-icon>
            <span>Delete Customer</span>
          </button>
        </mat-menu>
      </div>
    </header>

    <app-card variant="elevated" padding="large" class="summary-card">
      <div class="summary-card__grid">
        <div class="summary-card__item">
          <mat-icon>badge</mat-icon>
          <div>
            <span class="label">Name</span>
            <span class="value">{{ customer.firstName }} {{ customer.lastName }}</span>
          </div>
        </div>
        <div class="summary-card__item">
          <mat-icon>alternate_email</mat-icon>
          <div>
            <span class="label">Email</span>
            <span class="value value--truncate">{{ customer.email || 'Not provided' }}</span>
          </div>
        </div>
        <div class="summary-card__item">
          <mat-icon>call</mat-icon>
          <div>
            <span class="label">Phone</span>
            <span class="value">{{ customer.phone || 'Not provided' }}</span>
          </div>
        </div>
        <div class="summary-card__item summary-card__item--status" [class.inactive]="!customer.isActive">
          <mat-icon>{{ customer.isActive ? 'verified' : 'pause_circle' }}</mat-icon>
          <div>
            <span class="label">Status</span>
            <span class="value">{{ customer.isActive ? 'Active' : 'Inactive' }}</span>
          </div>
        </div>
        <div class="summary-card__item">
          <mat-icon>{{ getLoyaltyTierIcon(customer.loyaltyTier) }}</mat-icon>
          <div>
            <span class="label">Loyalty Tier</span>
            <span class="value" [style.color]="getLoyaltyTierColor(customer.loyaltyTier)">
              {{ customer.loyaltyTier | titlecase }}
            </span>
          </div>
        </div>
        <div class="summary-card__item">
          <mat-icon>stars</mat-icon>
          <div>
            <span class="label">Loyalty Points</span>
            <span class="value">{{ customer.loyaltyPoints | number }}</span>
          </div>
        </div>
        <div class="summary-card__item">
          <mat-icon>account_balance_wallet</mat-icon>
          <div>
            <span class="label">Total Spent</span>
            <span class="value">{{ formatCurrency(customer.totalSpent) }}</span>
          </div>
        </div>
        <div class="summary-card__item">
          <mat-icon>shopping_cart</mat-icon>
          <div>
            <span class="label">Total Purchases</span>
            <span class="value">{{ customer.totalPurchases | number }}</span>
          </div>
        </div>
      </div>
    </app-card>

    <div class="detail-layout">
      <div class="detail-layout__main">
        <app-card variant="default" padding="large" class="info-card">
          <div class="info-card__header">
            <div>
              <h2>Profile &amp; Contact</h2>
              <p>Essential information for communication and receipts.</p>
            </div>
            <mat-icon color="primary">contact_phone</mat-icon>
          </div>

          <dl class="info-list">
            <div class="info-list__item">
              <dt>Phone</dt>
              <dd>{{ customer.phone }}</dd>
            </div>
            <div class="info-list__item">
              <dt>Email</dt>
              <dd>{{ customer.email || 'Not provided' }}</dd>
            </div>
            <div class="info-list__item">
              <dt>Address</dt>
              <dd>{{ getFullAddress() }}</dd>
            </div>
            <div class="info-list__item">
              <dt>Date of Birth</dt>
              <dd>{{ formatDateShort(customer.dateOfBirth) }}</dd>
            </div>
            <div class="info-list__item">
              <dt>Gender</dt>
              <dd>{{ customer.gender ? (customer.gender | titlecase) : 'Not specified' }}</dd>
            </div>
          </dl>
        </app-card>

        <app-card variant="default" padding="large" class="info-card">
          <div class="info-card__header">
            <div>
              <h2>Activity Snapshot</h2>
              <p>Recent lifecycle milestones for this customer.</p>
            </div>
            <mat-icon color="primary">timeline</mat-icon>
          </div>

          <dl class="info-list">
            <div class="info-list__item">
              <dt>Member Since</dt>
              <dd>{{ formatDateShort(customer.createdAt) }}</dd>
            </div>
            <div class="info-list__item">
              <dt>Last Purchase</dt>
              <dd>{{ formatDateShort(customer.lastPurchaseDate) }}</dd>
            </div>
            <div class="info-list__item">
              <dt>Total Purchases</dt>
              <dd>{{ customer.totalPurchases | number }}</dd>
            </div>
            <div class="info-list__item">
              <dt>Total Spend</dt>
              <dd>{{ formatCurrency(customer.totalSpent) }}</dd>
            </div>
          </dl>
        </app-card>

        <app-card variant="default" padding="large" class="info-card" *ngIf="customer.notes">
          <div class="info-card__header">
            <div>
              <h2>Notes</h2>
              <p>Shared context for sales and support teams.</p>
            </div>
            <mat-icon color="primary">notes</mat-icon>
          </div>

          <p class="notes-text">{{ customer.notes }}</p>
        </app-card>
      </div>

      <aside class="detail-layout__aside">
        <app-card variant="default" padding="large" class="meta-card">
          <div class="meta-card__header">
            <div>
              <h2>Account Overview</h2>
              <p>Key attributes that drive loyalty experiences.</p>
            </div>
            <mat-icon color="primary">insights</mat-icon>
          </div>

          <div class="meta-grid">
            <div class="meta-grid__item">
              <span class="label">Status</span>
              <span class="value" [class.inactive]="!customer.isActive">
                {{ customer.isActive ? 'Active' : 'Inactive' }}
              </span>
            </div>
            <div class="meta-grid__item">
              <span class="label">Loyalty Tier</span>
              <span class="value">{{ customer.loyaltyTier | titlecase }}</span>
            </div>
            <div class="meta-grid__item">
              <span class="label">Points Balance</span>
              <span class="value">{{ customer.loyaltyPoints | number }}</span>
            </div>
            <div class="meta-grid__item">
              <span class="label">Customer Code</span>
              <span class="code-chip">{{ customer.customerCode }}</span>
            </div>
          </div>
        </app-card>

        <app-card variant="default" padding="large" class="meta-card">
          <div class="meta-card__header">
            <div>
              <h2>Engagement Timeline</h2>
              <p>Sales and loyalty history will appear here once connected.</p>
            </div>
            <mat-icon color="primary">hourglass_bottom</mat-icon>
          </div>

          <div class="placeholder">
            <mat-icon>hourglass_empty</mat-icon>
            <p>Integrate the sales module to surface purchase history and loyalty transactions.</p>
          </div>
        </app-card>
      </aside>
    </div>
  </section>
</ng-container>

<ng-template #customerLoading>
  <div class="loading-container loading-container--custom detail-skeleton">
    <div class="detail-skeleton__header skeleton"></div>
    <div class="detail-skeleton__summary">
      <div class="detail-skeleton__summary-item skeleton" *ngFor="let _ of summarySkeletonSlots"></div>
    </div>
    <div class="detail-skeleton__content">
      <div class="detail-skeleton__main">
        <div class="detail-skeleton__card skeleton" *ngFor="let _ of mainSkeletonSlots"></div>
      </div>
      <div class="detail-skeleton__aside">
        <div class="detail-skeleton__card skeleton" *ngFor="let _ of asideSkeletonSlots"></div>
      </div>
    </div>
  </div>
</ng-template>