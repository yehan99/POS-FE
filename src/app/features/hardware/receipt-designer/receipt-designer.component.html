<div class="receipt-designer-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <button class="btn-back" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        <span>Back</span>
      </button>
      <div class="title-section">
        <h1 class="page-title">Print Designer</h1>
        <p class="page-subtitle">Create and customize professional receipt templates</p>
      </div>
      <div class="header-actions">
        <button class="btn-icon" [class.active]="autoPreview" (click)="toggleAutoPreview()"
          [attr.aria-label]="autoPreview ? 'Disable auto-preview' : 'Enable auto-preview'">
          <mat-icon>{{ autoPreview ? "visibility" : "visibility_off" }}</mat-icon>
        </button>
        <button class="btn-primary" (click)="printPreview()" *ngIf="workingTemplate">
          <mat-icon>print</mat-icon>
          <span>Print Preview</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card">
      <div class="card-icon primary">
        <mat-icon>receipt_long</mat-icon>
      </div>
      <div class="card-content">
        <div class="card-value">{{ templates.length }}</div>
        <div class="card-label">Templates</div>
        <div class="card-sublabel">Total created</div>
      </div>
    </div>

    <div class="summary-card">
      <div class="card-icon success">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="card-content">
        <div class="card-value">{{ selectedTemplate ? 1 : 0 }}</div>
        <div class="card-label">Active</div>
        <div class="card-sublabel">Currently editing</div>
      </div>
    </div>

    <div class="summary-card">
      <div class="card-icon warning">
        <mat-icon>star</mat-icon>
      </div>
      <div class="card-content">
        <div class="card-value">{{ getDefaultTemplateCount() }}</div>
        <div class="card-label">Default</div>
        <div class="card-sublabel">Active template</div>
      </div>
    </div>

    <div class="summary-card">
      <div class="card-icon accent">
        <mat-icon>straighten</mat-icon>
      </div>
      <div class="card-content">
        <div class="card-value">{{ workingTemplate?.paperWidth || 80 }}mm</div>
        <div class="card-label">Paper Width</div>
        <div class="card-sublabel">Current size</div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="content-grid">
    <!-- Templates List Card -->
    <div class="card templates-card">
      <div class="card-header">
        <h2 class="card-title">
          <mat-icon>receipt_long</mat-icon>
          Templates
        </h2>
        <button class="btn-action" (click)="createNewTemplate()">
          <mat-icon>add</mat-icon>
          <span>New</span>
        </button>
      </div>
      <div class="card-body">
        <div class="templates-list" *ngIf="templates.length > 0">
          <div class="template-item" *ngFor="let template of templates"
            [class.selected]="selectedTemplate?.id === template.id" (click)="selectTemplate(template)">
            <div class="template-icon">
              <mat-icon>{{ template.isDefault ? 'star' : 'receipt' }}</mat-icon>
            </div>
            <div class="template-info">
              <div class="template-name">{{ template.name }}</div>
              <div class="template-meta">
                <span class="meta-item">{{ template.paperWidth }}mm</span>
                <span class="meta-item" *ngIf="template.isDefault">Default</span>
              </div>
            </div>
            <div class="template-actions">
              <button class="btn-icon-small" [matMenuTriggerFor]="itemMenu" (click)="$event.stopPropagation()">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #itemMenu="matMenu">
                <button mat-menu-item (click)="duplicateTemplate()">
                  <mat-icon>content_copy</mat-icon>
                  Duplicate
                </button>
                <button mat-menu-item (click)="setAsDefault()" *ngIf="!template.isDefault">
                  <mat-icon>star</mat-icon>
                  Set as Default
                </button>
                <button mat-menu-item (click)="exportTemplate()">
                  <mat-icon>download</mat-icon>
                  Export
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="deleteTemplate()" [disabled]="template.isDefault">
                  <mat-icon>delete</mat-icon>
                  Delete
                </button>
              </mat-menu>
            </div>
          </div>
        </div>
        <div class="empty-state" *ngIf="templates.length === 0">
          <mat-icon>receipt_long</mat-icon>
          <p>No templates yet</p>
          <button class="btn-primary" (click)="createNewTemplate()">Create First Template</button>
        </div>
      </div>
    </div>

    <!-- Editor Card -->
    <div class="card editor-card" *ngIf="selectedTemplate || isNewTemplate">
      <div class="card-header">
        <h2 class="card-title">
          <mat-icon>edit</mat-icon>
          {{ workingTemplate?.name || 'Template Editor' }}
        </h2>
        <div class="header-actions">
          <button class="btn-secondary" *ngIf="!isEditing" (click)="startEditing()">
            <mat-icon>edit</mat-icon>
            <span>Edit</span>
          </button>
          <button class="btn-primary" *ngIf="isEditing" (click)="saveTemplate()" [disabled]="!hasUnsavedChanges">
            <mat-icon>save</mat-icon>
            <span>Save</span>
          </button>
          <button class="btn-secondary" *ngIf="isEditing" (click)="cancelEditing()">
            Cancel
          </button>
          <button class="btn-icon" [matMenuTriggerFor]="templateMenu">
            <mat-icon>more_vert</mat-icon>
          </button>
        </div>
      </div>

      <mat-menu #templateMenu="matMenu">
        <button mat-menu-item (click)="duplicateTemplate()">
          <mat-icon>content_copy</mat-icon>
          Duplicate
        </button>
        <button mat-menu-item (click)="setAsDefault()" *ngIf="!selectedTemplate?.isDefault">
          <mat-icon>star</mat-icon>
          Set as Default
        </button>
        <button mat-menu-item (click)="exportTemplate()">
          <mat-icon>download</mat-icon>
          Export
        </button>
        <button mat-menu-item (click)="importInput.click()">
          <mat-icon>upload</mat-icon>
          Import
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="deleteTemplate()" [disabled]="selectedTemplate?.isDefault">
          <mat-icon>delete</mat-icon>
          Delete
        </button>
      </mat-menu>

      <input #importInput type="file" accept=".json" (change)="importTemplate($event)" style="display: none" />

      <div class="card-body" *ngIf="workingTemplate && isEditing">
        <!-- Basic Settings -->
        <div class="basic-settings">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Template Name</mat-label>
            <input matInput [(ngModel)]="workingTemplate.name" (ngModelChange)="onTemplateChange()" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <input matInput [(ngModel)]="workingTemplate.description" (ngModelChange)="onTemplateChange()" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Paper Width</mat-label>
            <mat-select [(ngModel)]="workingTemplate.paperWidth" (ngModelChange)="onTemplateChange()">
              <mat-option *ngFor="let width of paperWidths" [value]="width.value">
                {{ width.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Configuration Tabs -->
        <mat-tab-group [(selectedIndex)]="selectedTab" class="config-tabs" animationDuration="0ms">
          <!-- Header Tab -->
          <mat-tab label="Header">
            <div class="tab-content">
              <mat-slide-toggle [(ngModel)]="workingTemplate.sections.header.enabled"
                (ngModelChange)="onTemplateChange()">
                Enable Header Section
              </mat-slide-toggle>

              <div *ngIf="workingTemplate.sections.header.enabled" class="section-config">
                <!-- Logo -->
                <h3>Logo</h3>
                <mat-slide-toggle [(ngModel)]="workingTemplate.sections.header.logo!.enabled"
                  (ngModelChange)="onTemplateChange()">
                  Show Logo
                </mat-slide-toggle>

                <div *ngIf="workingTemplate.sections.header.logo?.enabled" class="logo-config">
                  <button mat-raised-button (click)="logoInput.click()">
                    <mat-icon>upload</mat-icon>
                    Upload Logo
                  </button>
                  <button mat-button (click)="removeLogo()" *ngIf="workingTemplate.sections.header.logo?.imageData">
                    <mat-icon>delete</mat-icon>
                    Remove Logo
                  </button>
                  <input #logoInput type="file" accept="image/*" (change)="uploadLogo($event)" style="display: none" />
                </div>

                <!-- Business Name -->
                <h3>Business Name</h3>
                <mat-slide-toggle [(ngModel)]="workingTemplate.sections.header.businessName.enabled"
                  (ngModelChange)="onTemplateChange()">
                  Show Business Name
                </mat-slide-toggle>

                <div *ngIf="workingTemplate.sections.header.businessName.enabled">
                  <mat-form-field appearance="outline">
                    <mat-label>Font Size</mat-label>
                    <mat-select [(ngModel)]="workingTemplate.sections.header.businessName.fontSize"
                      (ngModelChange)="onTemplateChange()">
                      <mat-option *ngFor="let size of fontSizes" [value]="size">
                        {{ size | titlecase }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-slide-toggle [(ngModel)]="workingTemplate.sections.header.businessName.bold"
                    (ngModelChange)="onTemplateChange()">
                    Bold
                  </mat-slide-toggle>
                </div>

                <!-- Address & Contact -->
                <h3>Address & Contact</h3>
                <mat-slide-toggle [(ngModel)]="workingTemplate.sections.header.address.enabled"
                  (ngModelChange)="onTemplateChange()">
                  Show Address
                </mat-slide-toggle>

                <mat-slide-toggle [(ngModel)]="workingTemplate.sections.header.contact.enabled"
                  (ngModelChange)="onTemplateChange()">
                  Show Contact Info
                </mat-slide-toggle>

                <div *ngIf="workingTemplate.sections.header.contact.enabled" class="contact-options">
                  <mat-checkbox [(ngModel)]="workingTemplate.sections.header.contact.showPhone"
                    (ngModelChange)="onTemplateChange()">
                    Phone
                  </mat-checkbox>
                  <mat-checkbox [(ngModel)]="workingTemplate.sections.header.contact.showEmail"
                    (ngModelChange)="onTemplateChange()">
                    Email
                  </mat-checkbox>
                </div>

                <!-- Alignment -->
                <mat-form-field appearance="outline">
                  <mat-label>Header Alignment</mat-label>
                  <mat-select [(ngModel)]="workingTemplate.sections.header.alignment"
                    (ngModelChange)="onTemplateChange()">
                    <mat-option *ngFor="let align of alignments" [value]="align">
                      {{ align | titlecase }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
          </mat-tab>

          <!-- Items Tab -->
          <mat-tab label="Items">
            <div class="tab-content">
              <mat-slide-toggle [(ngModel)]="workingTemplate.sections.items.enabled"
                (ngModelChange)="onTemplateChange()">
                Enable Items Section
              </mat-slide-toggle>

              <div *ngIf="workingTemplate.sections.items.enabled" class="section-config">
                <h3>Item Display Options</h3>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.items.showSKU" (ngModelChange)="onTemplateChange()">
                  Show SKU
                </mat-checkbox>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.items.showQuantity"
                  (ngModelChange)="onTemplateChange()">
                  Show Quantity
                </mat-checkbox>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.items.showUnitPrice"
                  (ngModelChange)="onTemplateChange()">
                  Show Unit Price
                </mat-checkbox>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.items.showItemTotal"
                  (ngModelChange)="onTemplateChange()">
                  Show Item Total
                </mat-checkbox>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.items.showDiscount"
                  (ngModelChange)="onTemplateChange()">
                  Show Discount
                </mat-checkbox>
              </div>
            </div>
          </mat-tab>

          <!-- Totals Tab -->
          <mat-tab label="Totals">
            <div class="tab-content">
              <mat-slide-toggle [(ngModel)]="workingTemplate.sections.totals.enabled"
                (ngModelChange)="onTemplateChange()">
                Enable Totals Section
              </mat-slide-toggle>

              <div *ngIf="workingTemplate.sections.totals.enabled" class="section-config">
                <h3>Totals Display Options</h3>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.totals.showSubtotal"
                  (ngModelChange)="onTemplateChange()">
                  Show Subtotal
                </mat-checkbox>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.totals.showDiscount"
                  (ngModelChange)="onTemplateChange()">
                  Show Discount
                </mat-checkbox>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.totals.showTax"
                  (ngModelChange)="onTemplateChange()">
                  Show Tax
                </mat-checkbox>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.totals.showTotal"
                  (ngModelChange)="onTemplateChange()">
                  Show Total
                </mat-checkbox>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.totals.showPaid"
                  (ngModelChange)="onTemplateChange()">
                  Show Paid Amount
                </mat-checkbox>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.totals.showChange"
                  (ngModelChange)="onTemplateChange()">
                  Show Change
                </mat-checkbox>

                <mat-slide-toggle [(ngModel)]="workingTemplate.sections.totals.boldTotal"
                  (ngModelChange)="onTemplateChange()">
                  Bold Total
                </mat-slide-toggle>
              </div>
            </div>
          </mat-tab>

          <!-- Footer Tab -->
          <mat-tab label="Footer">
            <div class="tab-content">
              <mat-slide-toggle [(ngModel)]="workingTemplate.sections.footer.enabled"
                (ngModelChange)="onTemplateChange()">
                Enable Footer Section
              </mat-slide-toggle>

              <div *ngIf="workingTemplate.sections.footer.enabled" class="section-config">
                <h3>Footer Options</h3>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.footer.showTransactionId"
                  (ngModelChange)="onTemplateChange()">
                  Show Transaction ID
                </mat-checkbox>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.footer.showCashier"
                  (ngModelChange)="onTemplateChange()">
                  Show Cashier
                </mat-checkbox>
                <mat-checkbox [(ngModel)]="workingTemplate.sections.footer.showDateTime"
                  (ngModelChange)="onTemplateChange()">
                  Show Date/Time
                </mat-checkbox>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Thank You Message</mat-label>
                  <textarea matInput [(ngModel)]="workingTemplate.sections.footer.thankYouMessage"
                    (ngModelChange)="onTemplateChange()" rows="2"></textarea>
                </mat-form-field>
              </div>
            </div>
          </mat-tab>

          <!-- Styles Tab -->
          <mat-tab label="Styles">
            <div class="tab-content">
              <h3>General Styles</h3>
              <mat-form-field appearance="outline">
                <mat-label>Font Family</mat-label>
                <mat-select [(ngModel)]="workingTemplate.styles.font" (ngModelChange)="onTemplateChange()">
                  <mat-option value="monospace">Monospace</mat-option>
                  <mat-option value="sans-serif">Sans-serif</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Border Style</mat-label>
                <mat-select [(ngModel)]="workingTemplate.styles.borderStyle" (ngModelChange)="onTemplateChange()">
                  <mat-option *ngFor="let style of borderStyles" [value]="style.value">
                    {{ style.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Section Spacing (lines)</mat-label>
                <input matInput type="number" min="0" max="5" [(ngModel)]="workingTemplate.styles.sectionSpacing"
                  (ngModelChange)="onTemplateChange()" />
              </mat-form-field>
            </div>
          </mat-tab>
        </mat-tab-group>

        <div class="editor-actions">
          <button class="btn-primary" (click)="saveTemplate()" [disabled]="!hasUnsavedChanges">
            <mat-icon>save</mat-icon>
            <span>Save Template</span>
          </button>
          <button class="btn-secondary" (click)="updatePreview()">
            <mat-icon>refresh</mat-icon>
            <span>Update Preview</span>
          </button>
        </div>
      </div>

      <div class="card-body view-mode" *ngIf="!isEditing && workingTemplate">
        <div class="info-message">
          <mat-icon>info</mat-icon>
          <p>Click "Edit" to modify this template</p>
        </div>
      </div>
    </div>

    <!-- Preview Card -->
    <div class="card preview-card">
      <div class="card-header">
        <h2 class="card-title">
          <mat-icon>visibility</mat-icon>
          Preview
        </h2>
        <button class="btn-icon" (click)="updatePreview()" *ngIf="workingTemplate">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
      <div class="card-body">
        <div class="receipt-preview">
          <div class="preview-paper" [style.width.mm]="workingTemplate?.paperWidth || 80">
            <pre class="preview-text">{{ previewText }}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
