<h2 mat-dialog-title>{{ title }}</h2>

<mat-dialog-content class="dialog-content">
    <form id="stockAdjustmentForm" [formGroup]="form" (ngSubmit)="submit()" class="adjustment-form">
        <div class="form-grid">
            <mat-form-field appearance="outline" class="form-field">
                <mat-label>Adjustment Number</mat-label>
                <input matInput formControlName="adjustmentNumber" placeholder="Auto-generated"
                    [readonly]="mode === 'create'" />
                <mat-icon matSuffix>tag</mat-icon>
                <mat-hint *ngIf="mode === 'create'">Sequence generated automatically</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
                <mat-label>Product</mat-label>
                <input matInput type="text" formControlName="productDisplay" [matAutocomplete]="productSearch"
                    [readonly]="mode === 'view'" placeholder="Search by name or SKU" />
                <button mat-icon-button matSuffix type="button"
                    *ngIf="mode === 'create' && form.get('productDisplay')?.value" (click)="clearProduct()"
                    aria-label="Clear selection">
                    <mat-icon>close</mat-icon>
                </button>
                <mat-progress-spinner matSuffix *ngIf="productSearchLoading" diameter="20"
                    mode="indeterminate"></mat-progress-spinner>
                <mat-error *ngIf="form.get('productId')?.hasError('required') && form.get('productDisplay')?.touched">
                    Select a product to continue.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
                <mat-label>Adjustment Type</mat-label>
                <mat-select formControlName="adjustmentType" [disabled]="mode === 'view'">
                    <mat-option *ngFor="let type of adjustmentTypes" [value]="type">
                        {{ type | titlecase }}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
                <mat-label>Quantity</mat-label>
                <input matInput type="number" formControlName="quantity" min="1" [readonly]="mode === 'view'" />
                <mat-error *ngIf="form.get('quantity')?.hasError('min')">Quantity must be at least 1.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
                <mat-label>Location (optional)</mat-label>
                <mat-select formControlName="locationId" [disabled]="mode === 'view'">
                    <mat-option [value]="null">All locations</mat-option>
                    <mat-option *ngFor="let location of locations" [value]="location.id">
                        {{ location.name }}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field form-field--full">
                <mat-label>Reason</mat-label>
                <textarea matInput rows="3" formControlName="reason" [readonly]="mode === 'view'"></textarea>
                <mat-hint align="end">{{ form.get('reason')?.value?.length || 0 }}/255</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field form-field--full">
                <mat-label>Notes (optional)</mat-label>
                <textarea matInput rows="3" formControlName="notes" [readonly]="mode === 'view'"></textarea>
                <mat-hint align="end">{{ form.get('notes')?.value?.length || 0 }}/2000</mat-hint>
            </mat-form-field>
        </div>

        <mat-divider></mat-divider>

        <div class="summary" *ngIf="mode === 'create'">
            <div class="summary__item" *ngIf="selectedProduct">
                <mat-icon color="primary">inventory_2</mat-icon>
                <div>
                    <p class="summary__label">Current Stock</p>
                    <p class="summary__value">
                        {{ selectedProduct?.stockQuantity | number }} units available
                    </p>
                </div>
            </div>
            <div class="summary__item">
                <mat-icon color="accent">calculate</mat-icon>
                <div>
                    <p class="summary__label">Net Quantity Change</p>
                    <p class="summary__value" [class.summary__value--positive]="quantityPreview > 0"
                        [class.summary__value--negative]="quantityPreview < 0">
                        {{ quantityPreview > 0 ? '+' : '' }}{{ quantityPreview }} unit(s)
                    </p>
                </div>
            </div>
        </div>

        <div class="details" *ngIf="mode === 'view' && adjustment">
            <div class="details__row">
                <span class="details__label">Status</span>
                <span class="details__value details__status details__status--{{ adjustment.status }}">
                    {{ getStatusLabel(adjustment.status) }}
                </span>
            </div>
            <div class="details__row">
                <span class="details__label">Net Quantity</span>
                <span class="details__value"
                    [ngClass]="{ 'details__value--positive': adjustment.netQuantity > 0, 'details__value--negative': adjustment.netQuantity < 0 }">
                    {{ adjustment.netQuantity > 0 ? '+' : '' }}{{ adjustment.netQuantity }}
                </span>
            </div>
            <div class="details__row" *ngIf="adjustment.createdBy">
                <span class="details__label">Created By</span>
                <span class="details__value">{{ adjustment.createdBy }}</span>
            </div>
            <div class="details__row" *ngIf="adjustment.approvedBy">
                <span class="details__label">Approved By</span>
                <span class="details__value">{{ adjustment.approvedBy }}</span>
            </div>
            <div class="details__row" *ngIf="adjustment.rejectedBy">
                <span class="details__label">Rejected By</span>
                <span class="details__value">{{ adjustment.rejectedBy }}</span>
            </div>
            <div class="details__row" *ngIf="adjustment.rejectionReason">
                <span class="details__label">Rejection Reason</span>
                <span class="details__value">{{ adjustment.rejectionReason }}</span>
            </div>
        </div>

        <mat-autocomplete #productSearch="matAutocomplete" [displayWith]="displayProductOption.bind(this)"
            (optionSelected)="onProductSelected($event)">
            <mat-option *ngFor="let option of productResults$ | async; trackBy: trackByOption" [value]="option">
                <div class="product-option">
                    <div class="product-option__primary">
                        <span class="product-option__name">{{ option.name }}</span>
                        <span class="product-option__sku">{{ option.sku }}</span>
                    </div>
                    <div class="product-option__meta" [class.product-option__meta--low]="option.stockQuantity <= 0">
                        {{ option.stockQuantity | number }} in stock
                    </div>
                </div>
            </mat-option>
            <mat-option *ngIf="(productResults$ | async)?.length === 0">
                No products found
            </mat-option>
        </mat-autocomplete>
    </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-button type="button" (click)="cancel()" [disabled]="isSubmitting">
        {{ mode === 'create' ? 'Cancel' : 'Close' }}
    </button>
    <button mat-flat-button color="primary" type="submit" form="stockAdjustmentForm" *ngIf="mode === 'create'"
        [disabled]="isSubmitting">
        <mat-icon *ngIf="!isSubmitting">check_circle</mat-icon>
        <mat-progress-spinner *ngIf="isSubmitting" mode="indeterminate" diameter="18"></mat-progress-spinner>
        <span>{{ isSubmitting ? 'Saving...' : 'Create Adjustment' }}</span>
    </button>
</mat-dialog-actions>