<div class="customer-dialog">
  <div class="dialog-header">
    <div class="header-icon">
      <mat-icon>person_search</mat-icon>
    </div>
    <div class="header-text">
      <h2>Select Customer</h2>
      <p>Search by phone or name to attach customer to order</p>
    </div>
    <button mat-icon-button (click)="cancel()" class="close-btn">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content>
    <!-- Autocomplete Search Field -->
    <div class="search-section">
      <mat-form-field appearance="outline" class="search-field">
        <mat-icon matPrefix class="search-icon">search</mat-icon>
        <mat-label>Search by phone or name</mat-label>
        <input type="text" matInput [formControl]="searchControl" [matAutocomplete]="auto"
          (input)="onSearchChange(searchControl.value)" placeholder="e.g., 077123456 or John Doe" autocomplete="off">
        <mat-hint>Type at least 2 characters to begin searching</mat-hint>
        <mat-spinner *ngIf="isSearching && searchControl.value && searchControl.value.length >= 2" diameter="20"
          matSuffix class="search-spinner"></mat-spinner>
        <button *ngIf="searchControl.value && !isSearching" mat-icon-button matSuffix (click)="clearSearch()"
          aria-label="Clear search">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayCustomer"
        (optionSelected)="onCustomerSelected($event.option.value)" class="customer-autocomplete">
        <mat-option *ngIf="isSearching" disabled>
          <div class="loading-option">
            <mat-spinner diameter="24"></mat-spinner>
            <span>Searching customers...</span>
          </div>
        </mat-option>

        <ng-container *ngIf="!isSearching && (searchResults$ | async) as results">
          <mat-option *ngFor="let customer of results" [value]="customer" class="customer-option">
            <div class="autocomplete-option">
              <div class="option-avatar">
                <mat-icon>person</mat-icon>
              </div>
              <div class="option-info">
                <div class="option-name">
                  {{ getCustomerName(customer) }}
                  <span class="option-tier" *ngIf="customer.loyaltyTier">
                    {{ customer.loyaltyTier }}
                  </span>
                </div>
                <div class="option-details">
                  <span *ngIf="customer.phone">{{ customer.phone }}</span>
                  <span *ngIf="customer.email"> • {{ customer.email }}</span>
                  <span *ngIf="customer.loyaltyPoints"> • {{ customer.loyaltyPoints }} pts</span>
                </div>
              </div>
            </div>
          </mat-option>

          <mat-option *ngIf="results.length === 0" disabled>
            <div class="no-results">
              <mat-icon>search_off</mat-icon>
              <div class="no-results-text">
                <span class="title">No customers found</span>
                <span class="subtitle">Try a different search term</span>
              </div>
            </div>
          </mat-option>
        </ng-container>
      </mat-autocomplete>
    </div>

    <!-- Selected Customer Display -->
    <div class="selected-customer" *ngIf="selectedCustomer">
      <div class="customer-card">
        <div class="card-header">
          <mat-icon>check_circle</mat-icon>
          <span>Selected Customer</span>
        </div>
        <div class="card-body">
          <div class="customer-avatar-large">
            <mat-icon>person</mat-icon>
          </div>
          <div class="customer-details-large">
            <h3>{{ getCustomerName(selectedCustomer) }}</h3>
            <div class="detail-row" *ngIf="selectedCustomer.phone">
              <mat-icon>phone</mat-icon>
              <span>{{ selectedCustomer.phone }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedCustomer.email">
              <mat-icon>email</mat-icon>
              <span>{{ selectedCustomer.email }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedCustomer.loyaltyPoints">
              <mat-icon>stars</mat-icon>
              <span>{{ selectedCustomer.loyaltyPoints }} Loyalty Points</span>
            </div>
            <div class="detail-row" *ngIf="selectedCustomer.loyaltyTier">
              <mat-icon>workspace_premium</mat-icon>
              <span class="tier-badge">{{ selectedCustomer.loyaltyTier | titlecase }} Tier</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions>
    <button mat-stroked-button (click)="cancel()" class="cancel-btn">
      <mat-icon>close</mat-icon>
      <span>Cancel</span>
    </button>
    <button mat-raised-button (click)="confirmSelection()" [disabled]="!selectedCustomer" class="select-btn">
      <mat-icon>check</mat-icon>
      <span>Attach Customer</span>
    </button>
  </mat-dialog-actions>
</div>