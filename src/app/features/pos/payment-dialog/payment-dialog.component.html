<div class="payment-dialog">
  <div class="dialog-header">
    <div class="header-content">
      <div class="header-icon">
        <mat-icon>credit_card</mat-icon>
      </div>
      <div class="header-text">
        <h2 mat-dialog-title>Payment</h2>
        <p>Complete transaction securely</p>
      </div>
    </div>
    <button mat-icon-button (click)="cancel()" class="close-btn">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content>
    <!-- Order Summary -->
    <div class="order-summary">
      <div class="summary-header">
        <mat-icon>receipt_long</mat-icon>
        <span>Order Summary</span>
      </div>
      <div class="summary-lines">
        <div class="summary-row">
          <span class="label">Subtotal:</span>
          <span class="value">{{ formatCurrency(data.subtotal) }}</span>
        </div>
        <div class="summary-row" *ngIf="data.discount > 0">
          <span class="label">Discount:</span>
          <span class="value discount">-{{ formatCurrency(data.discount) }}</span>
        </div>
        <div class="summary-row">
          <span class="label">Tax:</span>
          <span class="value">{{ formatCurrency(data.tax) }}</span>
        </div>
      </div>
      <div class="summary-divider"></div>
      <div class="summary-total">
        <span class="label">Total Amount:</span>
        <span class="value">{{ formatCurrency(data.total) }}</span>
      </div>
    </div>

    <!-- Payment Method Selection -->
    <div class="payment-methods">
      <div class="methods-header">
        <mat-icon>payment</mat-icon>
        <span>Select Payment Method</span>
      </div>
      <div class="methods-grid">
        <button [class.active]="selectedMethod === 'cash'" (click)="selectMethod('cash')" class="method-btn">
          <div class="method-icon">
            <mat-icon>payments</mat-icon>
          </div>
          <span>Cash</span>
        </button>

        <button [class.active]="selectedMethod === 'card'" (click)="selectMethod('card')" class="method-btn">
          <div class="method-icon">
            <mat-icon>credit_card</mat-icon>
          </div>
          <span>Card</span>
        </button>

        <button [class.active]="selectedMethod === 'mobile'" (click)="selectMethod('mobile')" class="method-btn">
          <div class="method-icon">
            <mat-icon>phone_android</mat-icon>
          </div>
          <span>Mobile</span>
        </button>

        <button [class.active]="selectedMethod === 'multiple'" (click)="selectMethod('multiple')" class="method-btn">
          <div class="method-icon">
            <mat-icon>call_split</mat-icon>
          </div>
          <span>Split</span>
        </button>
      </div>
    </div>

    <form [formGroup]="paymentForm">
      <!-- Cash Payment -->
      <div *ngIf="selectedMethod === 'cash'" class="payment-section">
        <h3>Cash Payment</h3>

        <!-- Quick amounts -->
        <div class="quick-amounts">
          <button *ngFor="let amount of quickAmounts" mat-stroked-button type="button"
            (click)="selectQuickAmount(amount)">
            {{ formatCurrency(amount) }}
          </button>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Cash Received</mat-label>
          <input matInput type="number" formControlName="cashAmount" />
          <span matPrefix>LKR&nbsp;</span>
        </mat-form-field>

        <div class="change-display">
          <div class="change-label">Change</div>
          <div class="change-amount">{{ formatCurrency(change) }}</div>
        </div>
      </div>

      <!-- Card Payment -->
      <div *ngIf="selectedMethod === 'card'" class="payment-section">
        <h3>Card Payment</h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Card Type</mat-label>
          <mat-select formControlName="cardType">
            <mat-option *ngFor="let type of cardTypes" [value]="type">
              {{ type }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Last 4 Digits</mat-label>
          <input matInput type="text" formControlName="cardLastFour" maxlength="4" placeholder="1234" />
          <mat-error>Enter 4 digits</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Reference/Approval Code (Optional)</mat-label>
          <input matInput type="text" formControlName="cardReference" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Amount</mat-label>
          <input matInput type="number" formControlName="cardAmount" [value]="data.total" readonly />
          <span matPrefix>LKR&nbsp;</span>
        </mat-form-field>
      </div>

      <!-- Mobile Payment -->
      <div *ngIf="selectedMethod === 'mobile'" class="payment-section">
        <h3>Mobile Payment</h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Provider</mat-label>
          <mat-select formControlName="mobileProvider">
            <mat-option *ngFor="let provider of mobileProviders" [value]="provider">
              {{ provider }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Mobile Number</mat-label>
          <input matInput type="tel" formControlName="mobileNumber" placeholder="0771234567" />
          <mat-error>Enter valid 10-digit number</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Transaction Reference</mat-label>
          <input matInput type="text" formControlName="mobileReference" placeholder="Required" />
          <mat-error>Reference is required</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Amount</mat-label>
          <input matInput type="number" formControlName="mobileAmount" [value]="data.total" readonly />
          <span matPrefix>LKR&nbsp;</span>
        </mat-form-field>
      </div>

      <!-- Split Payment -->
      <div *ngIf="selectedMethod === 'multiple'" class="payment-section">
        <h3>Split Payment</h3>

        <div class="split-info">
          <div class="info-row">
            <span>Total Required:</span>
            <strong>{{ formatCurrency(data.total) }}</strong>
          </div>
          <div class="info-row">
            <span>Total Paid:</span>
            <strong [class.complete]="getTotalPaid() >= data.total">
              {{ formatCurrency(getTotalPaid()) }}
            </strong>
          </div>
          <div class="info-row" *ngIf="getRemainingAmount() > 0">
            <span>Remaining:</span>
            <strong class="remaining">{{ formatCurrency(getRemainingAmount()) }}</strong>
          </div>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Cash Amount</mat-label>
          <input matInput type="number" formControlName="splitCash" (input)="calculateChange()" />
          <span matPrefix>LKR&nbsp;</span>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Card Amount</mat-label>
          <input matInput type="number" formControlName="splitCard" (input)="calculateChange()" />
          <span matPrefix>LKR&nbsp;</span>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Mobile Amount</mat-label>
          <input matInput type="number" formControlName="splitMobile" (input)="calculateChange()" />
          <span matPrefix>LKR&nbsp;</span>
        </mat-form-field>

        <div class="change-display" *ngIf="change > 0">
          <div class="change-label">Change</div>
          <div class="change-amount">{{ formatCurrency(change) }}</div>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions>
    <button mat-stroked-button (click)="cancel()" class="cancel-btn">
      <mat-icon>close</mat-icon>
      <span>Cancel</span>
    </button>
    <button mat-raised-button (click)="completePayment()" [disabled]="!canCompletePayment()" class="complete-btn">
      <mat-icon>check_circle</mat-icon>
      <span>Complete Payment</span>
    </button>
  </mat-dialog-actions>
</div>