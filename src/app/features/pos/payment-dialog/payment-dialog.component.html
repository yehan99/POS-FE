<div class="payment-dialog">
  <div class="dialog-header">
    <h2 mat-dialog-title>
      <mat-icon>payment</mat-icon>
      Payment
    </h2>
    <button mat-icon-button (click)="cancel()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content>
    <!-- Order Summary -->
    <div class="order-summary">
      <div class="summary-row">
        <span>Subtotal:</span>
        <span class="amount">{{ formatCurrency(data.subtotal) }}</span>
      </div>
      <div class="summary-row" *ngIf="data.discount > 0">
        <span>Discount:</span>
        <span class="amount discount">-{{ formatCurrency(data.discount) }}</span>
      </div>
      <div class="summary-row">
        <span>Tax:</span>
        <span class="amount">{{ formatCurrency(data.tax) }}</span>
      </div>
      <mat-divider></mat-divider>
      <div class="summary-row total">
        <span>Total Amount:</span>
        <span class="amount">{{ formatCurrency(data.total) }}</span>
      </div>
    </div>

    <!-- Payment Method Selection -->
    <div class="payment-methods">
      <button mat-raised-button [color]="selectedMethod === 'cash' ? 'primary' : ''" (click)="selectMethod('cash')"
        class="method-btn">
        <mat-icon>payments</mat-icon>
        <span>Cash</span>
      </button>

      <button mat-raised-button [color]="selectedMethod === 'card' ? 'primary' : ''" (click)="selectMethod('card')"
        class="method-btn">
        <mat-icon>credit_card</mat-icon>
        <span>Card</span>
      </button>

      <button mat-raised-button [color]="selectedMethod === 'mobile' ? 'primary' : ''" (click)="selectMethod('mobile')"
        class="method-btn">
        <mat-icon>phone_android</mat-icon>
        <span>Mobile</span>
      </button>

      <button mat-raised-button [color]="selectedMethod === 'multiple' ? 'primary' : ''"
        (click)="selectMethod('multiple')" class="method-btn">
        <mat-icon>call_split</mat-icon>
        <span>Split</span>
      </button>
    </div>

    <form [formGroup]="paymentForm">
      <!-- Cash Payment -->
      <div *ngIf="selectedMethod === 'cash'" class="payment-section">
        <h3>Cash Payment</h3>

        <!-- Quick amounts -->
        <div class="quick-amounts">
          <button *ngFor="let amount of quickAmounts" mat-stroked-button type="button"
            (click)="selectQuickAmount(amount)">
            {{ formatCurrency(amount) }}
          </button>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Cash Received</mat-label>
          <input matInput type="number" formControlName="cashAmount" />
          <span matPrefix>LKR&nbsp;</span>
        </mat-form-field>

        <div class="change-display">
          <div class="change-label">Change</div>
          <div class="change-amount">{{ formatCurrency(change) }}</div>
        </div>
      </div>

      <!-- Card Payment -->
      <div *ngIf="selectedMethod === 'card'" class="payment-section">
        <h3>Card Payment</h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Card Type</mat-label>
          <mat-select formControlName="cardType">
            <mat-option *ngFor="let type of cardTypes" [value]="type">
              {{ type }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Last 4 Digits</mat-label>
          <input matInput type="text" formControlName="cardLastFour" maxlength="4" placeholder="1234" />
          <mat-error>Enter 4 digits</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Reference/Approval Code (Optional)</mat-label>
          <input matInput type="text" formControlName="cardReference" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Amount</mat-label>
          <input matInput type="number" formControlName="cardAmount" [value]="data.total" readonly />
          <span matPrefix>LKR&nbsp;</span>
        </mat-form-field>
      </div>

      <!-- Mobile Payment -->
      <div *ngIf="selectedMethod === 'mobile'" class="payment-section">
        <h3>Mobile Payment</h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Provider</mat-label>
          <mat-select formControlName="mobileProvider">
            <mat-option *ngFor="let provider of mobileProviders" [value]="provider">
              {{ provider }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Mobile Number</mat-label>
          <input matInput type="tel" formControlName="mobileNumber" placeholder="0771234567" />
          <mat-error>Enter valid 10-digit number</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Transaction Reference</mat-label>
          <input matInput type="text" formControlName="mobileReference" placeholder="Required" />
          <mat-error>Reference is required</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Amount</mat-label>
          <input matInput type="number" formControlName="mobileAmount" [value]="data.total" readonly />
          <span matPrefix>LKR&nbsp;</span>
        </mat-form-field>
      </div>

      <!-- Split Payment -->
      <div *ngIf="selectedMethod === 'multiple'" class="payment-section">
        <h3>Split Payment</h3>

        <div class="split-info">
          <div class="info-row">
            <span>Total Required:</span>
            <strong>{{ formatCurrency(data.total) }}</strong>
          </div>
          <div class="info-row">
            <span>Total Paid:</span>
            <strong [class.complete]="getTotalPaid() >= data.total">
              {{ formatCurrency(getTotalPaid()) }}
            </strong>
          </div>
          <div class="info-row" *ngIf="getRemainingAmount() > 0">
            <span>Remaining:</span>
            <strong class="remaining">{{ formatCurrency(getRemainingAmount()) }}</strong>
          </div>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Cash Amount</mat-label>
          <input matInput type="number" formControlName="splitCash" (input)="calculateChange()" />
          <span matPrefix>LKR&nbsp;</span>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Card Amount</mat-label>
          <input matInput type="number" formControlName="splitCard" (input)="calculateChange()" />
          <span matPrefix>LKR&nbsp;</span>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Mobile Amount</mat-label>
          <input matInput type="number" formControlName="splitMobile" (input)="calculateChange()" />
          <span matPrefix>LKR&nbsp;</span>
        </mat-form-field>

        <div class="change-display" *ngIf="change > 0">
          <div class="change-label">Change</div>
          <div class="change-amount">{{ formatCurrency(change) }}</div>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-stroked-button (click)="cancel()">Cancel</button>
    <button mat-raised-button color="primary" (click)="completePayment()" [disabled]="!canCompletePayment()"
      class="complete-btn">
      <mat-icon>check_circle</mat-icon>
      Complete Payment
    </button>
  </mat-dialog-actions>
</div>
