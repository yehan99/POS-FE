<section class="transaction-history">
  <header class="page-header">
    <div class="page-header__title">
      <button mat-icon-button routerLink="/pos" matTooltip="Back to POS" class="ghost-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div>
        <p class="eyebrow">Sales &amp; CRM</p>
        <h1>Transaction History</h1>
      </div>
    </div>
    <div class="page-header__actions">
      <button mat-stroked-button type="button" (click)="clearFilters()">
        <mat-icon>filter_alt_off</mat-icon>
        Reset Filters
      </button>
      <button mat-flat-button color="primary" (click)="exportTransactions()" class="action-primary">
        <mat-icon>download</mat-icon>
        Export CSV
      </button>
    </div>
  </header>

  <app-card variant="elevated" padding="large" class="dashboard-overview">
    <div class="dashboard-overview__header">
      <div>
        <h2>Transaction Insights</h2>
        <p>Monitor sales mix, payment performance, and recent activity.</p>
      </div>
      <div class="period-toggle">
        <button *ngFor="let option of dashboardPeriods" mat-stroked-button type="button"
          [ngClass]="{ active: dashboardPeriod === option.value }" (click)="onDashboardPeriodChange(option.value)">
          {{ option.label }}
        </button>
      </div>
    </div>

    <div *ngIf="dashboardLoading" class="dashboard-overview__loading">
      <mat-progress-bar mode="indeterminate" color="primary"></mat-progress-bar>
    </div>

    <ng-container *ngIf="!dashboardLoading">
      <ng-container *ngIf="dashboardData; else dashboardFallback">
        <div class="summary-grid">
          <div class="summary-card primary">
            <div class="summary-card__icon">
              <mat-icon>payments</mat-icon>
            </div>
            <div class="summary-card__body">
              <p>Total Sales</p>
              <h3>{{ formatCurrency(dashboardData.summary.totalSales) }}</h3>
              <small>{{ dashboardPeriodLabel }}</small>
            </div>
          </div>
          <div class="summary-card accent">
            <div class="summary-card__icon">
              <mat-icon>account_balance_wallet</mat-icon>
            </div>
            <div class="summary-card__body">
              <p>Net Sales</p>
              <h3>{{ formatCurrency(dashboardData.summary.netSales) }}</h3>
              <small>After refunds</small>
            </div>
          </div>
          <div class="summary-card neutral">
            <div class="summary-card__icon">
              <mat-icon>receipt_long</mat-icon>
            </div>
            <div class="summary-card__body">
              <p>Transactions</p>
              <h3>{{ dashboardData.summary.totalTransactions | number }}</h3>
              <small>{{ dashboardData.summary.completedTransactions | number }} completed</small>
            </div>
          </div>
          <div class="summary-card dark">
            <div class="summary-card__icon">
              <mat-icon>equalizer</mat-icon>
            </div>
            <div class="summary-card__body">
              <p>Avg Transaction</p>
              <h3>{{ formatCurrency(dashboardData.summary.averageTransactionValue) }}</h3>
              <small>Per sale</small>
            </div>
          </div>
        </div>

        <div class="status-grid">
          <div class="status-card success">
            <span>Completed</span>
            <strong>{{ dashboardData.summary.completedTransactions | number }}</strong>
          </div>
          <div class="status-card warning">
            <span>Pending</span>
            <strong>{{ dashboardData.summary.pendingTransactions | number }}</strong>
          </div>
          <div class="status-card danger">
            <span>Cancelled</span>
            <strong>{{ dashboardData.summary.cancelledTransactions | number }}</strong>
          </div>
          <div class="status-card info">
            <span>Refunds</span>
            <strong>{{ formatCurrency(dashboardData.summary.totalRefunds) }}</strong>
          </div>
        </div>

        <div class="insights-grid">
          <app-card variant="default" padding="large" class="insight-card">
            <div class="insight-card__header">
              <h3>Payment Breakdown</h3>
              <p>Share of completed sales</p>
            </div>
            <div class="breakdown-list" *ngIf="dashboardData.paymentBreakdown.length; else emptyPayment">
              <div class="breakdown-row" *ngFor="let method of dashboardData.paymentBreakdown">
                <div class="breakdown-row__info">
                  <p>{{ method.method | titlecase }}</p>
                  <small>{{ method.transactionCount | number }} transactions</small>
                </div>
                <div class="breakdown-row__values">
                  <span class="amount">{{ formatCurrency(method.amount) }}</span>
                  <span class="percentage">{{ formatPercentage(method.percentage) }}</span>
                </div>
                <mat-progress-bar mode="determinate" [value]="method.percentage" color="primary"></mat-progress-bar>
              </div>
            </div>
            <ng-template #emptyPayment>
              <p class="empty-hint">No payment data for this period.</p>
            </ng-template>
          </app-card>

          <app-card variant="default" padding="large" class="insight-card">
            <div class="insight-card__header">
              <h3>Status Mix</h3>
              <p>Distribution of all transactions</p>
            </div>
            <div class="breakdown-list" *ngIf="dashboardData.statusBreakdown.length; else emptyStatus">
              <div class="breakdown-row" *ngFor="let status of dashboardData.statusBreakdown">
                <div class="breakdown-row__info">
                  <p>{{ status.status | titlecase }}</p>
                  <small>{{ status.count | number }} records</small>
                </div>
                <div class="breakdown-row__values">
                  <span class="percentage">{{ formatPercentage(status.percentage) }}</span>
                </div>
                <mat-progress-bar mode="determinate" [value]="status.percentage" color="accent"></mat-progress-bar>
              </div>
            </div>
            <ng-template #emptyStatus>
              <p class="empty-hint">No transactions recorded for this range.</p>
            </ng-template>
          </app-card>
        </div>

        <div class="insights-grid insights-grid--wide">
          <app-card variant="default" padding="large" class="insight-card">
            <div class="insight-card__header">
              <h3>Sales Trend</h3>
              <p>Daily movement</p>
            </div>
            <div class="trend-table" *ngIf="dashboardData.trend.length; else emptyTrend">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Sales</th>
                    <th>Transactions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let point of dashboardData.trend">
                    <td>{{ formatTrendDate(point.date) }}</td>
                    <td>{{ formatCurrency(point.totalSales) }}</td>
                    <td>{{ point.transactionCount | number }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <ng-template #emptyTrend>
              <p class="empty-hint">Trend data not available for this period.</p>
            </ng-template>
          </app-card>

          <app-card variant="default" padding="large" class="insight-card">
            <div class="insight-card__header">
              <h3>Top Cashiers</h3>
              <p>Sorted by revenue</p>
            </div>
            <div class="cashier-table" *ngIf="dashboardData.topCashiers.length; else emptyCashiers">
              <table>
                <thead>
                  <tr>
                    <th>Cashier</th>
                    <th>Transactions</th>
                    <th>Avg Sale</th>
                    <th>Total Sales</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let cashier of dashboardData.topCashiers">
                    <td>{{ cashier.cashierName || 'Unnamed Cashier' }}</td>
                    <td>{{ cashier.transactionCount | number }}</td>
                    <td>{{ formatCurrency(cashier.averageSaleValue) }}</td>
                    <td>{{ formatCurrency(cashier.totalSales) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <ng-template #emptyCashiers>
              <p class="empty-hint">No cashier performance data yet.</p>
            </ng-template>
          </app-card>
        </div>

        <app-card variant="default" padding="large" class="recent-card">
          <div class="insight-card__header">
            <h3>Recent Transactions</h3>
            <p>Latest five sales</p>
          </div>
          <div class="recent-list" *ngIf="dashboardData.recentTransactions.length; else emptyRecent">
            <div class="recent-item" *ngFor="let recent of dashboardData.recentTransactions">
              <div class="recent-item__meta">
                <span class="label">{{ recent.transactionNumber }}</span>
                <small>{{ recent.transactionDate | date: 'short' }}</small>
              </div>
              <div class="recent-item__customer">
                <p>{{ recent.customerName }}</p>
                <span>{{ recent.itemsCount }} item{{ recent.itemsCount === 1 ? '' : 's' }}</span>
              </div>
              <div class="recent-item__values">
                <span class="amount">{{ formatCurrency(recent.total) }}</span>
                <mat-chip [color]="getStatusColor(recent.status)">
                  {{ recent.status | titlecase }}
                </mat-chip>
              </div>
            </div>
          </div>
          <ng-template #emptyRecent>
            <p class="empty-hint">No recent activity.</p>
          </ng-template>
        </app-card>
      </ng-container>
    </ng-container>

    <ng-template #dashboardFallback>
      <div class="dashboard-empty-state">
        <mat-icon>insights</mat-icon>
        <p>{{ dashboardError || 'No dashboard data available yet.' }}</p>
      </div>
    </ng-template>
  </app-card>

  <app-card variant="elevated" padding="large" class="filter-panel">
    <div class="filter-panel__header">
      <div>
        <h2>Smart Filters</h2>
        <p>Refine by timeframe, payment method, status, or transaction value.</p>
      </div>
      <div class="filter-panel__meta">
        <mat-icon color="primary">tune</mat-icon>
        <span>{{ totalTransactions | number }} records</span>
      </div>
    </div>

    <form [formGroup]="filterForm" class="filter-grid">
      <mat-form-field appearance="outline" class="filter-grid__search filter-grid__field">
        <mat-label>Search transactions</mat-label>
        <input matInput formControlName="searchTerm" placeholder="Transaction #, Customer, or note">
        <mat-icon matPrefix>search</mat-icon>
        <button *ngIf="filterForm.get('searchTerm')?.value" mat-icon-button matSuffix type="button"
          (click)="filterForm.get('searchTerm')?.reset('')">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-grid__field">
        <mat-label>Start date</mat-label>
        <input matInput [matDatepicker]="startPicker" formControlName="startDate">
        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-grid__field">
        <mat-label>End date</mat-label>
        <input matInput [matDatepicker]="endPicker" formControlName="endDate">
        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
        <mat-datepicker #endPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-grid__field">
        <mat-label>Payment method</mat-label>
        <mat-select formControlName="paymentMethod">
          <mat-option value="">All methods</mat-option>
          <mat-option *ngFor="let method of paymentMethods" [value]="method">
            {{ method | titlecase }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-grid__field">
        <mat-label>Status</mat-label>
        <mat-select formControlName="status">
          <mat-option value="">All statuses</mat-option>
          <mat-option *ngFor="let status of statuses" [value]="status">
            {{ status | titlecase }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-grid__field">
        <mat-label>Minimum amount</mat-label>
        <input matInput type="number" formControlName="minAmount" placeholder="0.00">
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-grid__field">
        <mat-label>Maximum amount</mat-label>
        <input matInput type="number" formControlName="maxAmount" placeholder="0.00">
      </mat-form-field>

      <div class="filter-grid__footer">
        <span *ngIf="isLoading" class="filter-grid__loading">
          <mat-progress-bar mode="indeterminate" color="primary"></mat-progress-bar>
        </span>
        <button mat-stroked-button color="primary" type="button" (click)="loadTransactions()">
          <mat-icon>refresh</mat-icon>
          Apply Filters
        </button>
      </div>
    </form>
  </app-card>

  <app-card variant="default" padding="none" class="table-card mt-4">
    <div class="table-card__header">
      <div>
        <h2>Transactions</h2>
        <p>Browse all recorded sales with real-time filtering and quick actions.</p>
      </div>
      <div class="table-card__meta" *ngIf="transactions.length">
        <mat-icon color="primary">bar_chart</mat-icon>
        <span>{{ transactions.length | number }} result{{ transactions.length === 1 ? '' : 's' }} on this page</span>
      </div>
    </div>

    <div class="table-container">
      <table mat-table [dataSource]="transactions" matSort class="transactions-table">
        <!-- Transaction Number Column -->
        <ng-container matColumnDef="transactionNumber">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Transaction #</th>
          <td mat-cell *matCellDef="let transaction">
            <span class="transaction-number">{{ transaction.transactionNumber }}</span>
          </td>
        </ng-container>

        <!-- Date Column -->
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Date & Time</th>
          <td mat-cell *matCellDef="let transaction">
            {{ transaction.date | date:'short' }}
          </td>
        </ng-container>

        <!-- Customer Column -->
        <ng-container matColumnDef="customerName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Customer</th>
          <td mat-cell *matCellDef="let transaction">
            {{ transaction.customerName || 'Walk-in' }}
          </td>
        </ng-container>

        <!-- Items Column -->
        <ng-container matColumnDef="items">
          <th mat-header-cell *matHeaderCellDef>Items</th>
          <td mat-cell *matCellDef="let transaction">
            <mat-chip class="item-chip">
              {{ getItemCount(transaction) }} item(s)
            </mat-chip>
          </td>
        </ng-container>

        <!-- Total Column -->
        <ng-container matColumnDef="total">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Total</th>
          <td mat-cell *matCellDef="let transaction" class="amount">
            LKR {{ transaction.total | number:'1.2-2' }}
          </td>
        </ng-container>

        <!-- Payment Method Column -->
        <ng-container matColumnDef="paymentMethod">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Payment</th>
          <td mat-cell *matCellDef="let transaction">
            <div class="payment-method">
              <mat-icon>{{ getPaymentMethodIcon(transaction.paymentMethod) }}</mat-icon>
              <span>{{ transaction.paymentMethod | titlecase }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
          <td mat-cell *matCellDef="let transaction">
            <mat-chip [color]="getStatusColor(transaction.status)">
              {{ transaction.status | titlecase }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let transaction" class="actions-cell">
            <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Actions">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="viewTransaction(transaction)">
                <mat-icon>visibility</mat-icon>
                <span>View Details</span>
              </button>
              <button mat-menu-item (click)="printReceipt(transaction)">
                <mat-icon>print</mat-icon>
                <span>Print Receipt</span>
              </button>
              <button mat-menu-item (click)="refundTransaction(transaction)"
                [disabled]="transaction.status !== 'completed'">
                <mat-icon>undo</mat-icon>
                <span>Refund</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <!-- No Data State -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
            <div class="empty-state">
              <mat-icon>inventory_2</mat-icon>
              <h3>No transactions found</h3>
              <p>Try adjusting the filters or search for another term.</p>
              <button mat-stroked-button color="primary" type="button" (click)="clearFilters()">
                Reset filters
              </button>
            </div>
          </td>
        </tr>
      </table>
    </div>

    <div class="table-footer">
      <div class="table-footer__summary">
        <mat-icon>info</mat-icon>
        <span>
          Showing page {{ currentPage }} of {{ totalPages }} Â·
          {{ totalTransactions | number }} total transactions
        </span>
      </div>

      <mat-paginator [length]="totalTransactions" [pageSize]="pageSize" [pageSizeOptions]="[10, 20, 50, 100]"
        (page)="onPageChange($event)" showFirstLastButtons>
      </mat-paginator>
    </div>
  </app-card>
</section>