<div class="user-management">
  <div class="page-header">
    <div>
      <h1>User Management</h1>
      <p class="subtitle">
        Provision users with roles and site assignments for Google single sign-on access.
      </p>
    </div>
    <button mat-stroked-button color="primary" type="button" (click)="refreshUsers()" [disabled]="isLoadingUsers">
      <mat-icon>refresh</mat-icon>
      <span>Refresh</span>
    </button>
  </div>

  <div class="content-grid">
    <mat-card class="form-card">
      <h2 class="card-title">Invite New User</h2>
      <p class="card-caption">
        Add a team member and the system will allow them to sign in with their Google account.
      </p>

      <form [formGroup]="userForm" (ngSubmit)="submit()" class="user-form">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>First Name</mat-label>
            <input matInput formControlName="firstName" autocomplete="given-name" />
            <mat-error *ngIf="userForm.get('firstName')?.hasError('required')">
              First name is required
            </mat-error>
            <mat-error *ngIf="userForm.get('firstName')?.hasError('minlength')">
              Minimum 2 characters required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Last Name</mat-label>
            <input matInput formControlName="lastName" autocomplete="family-name" />
            <mat-error *ngIf="userForm.get('lastName')?.hasError('required')">
              Last name is required
            </mat-error>
            <mat-error *ngIf="userForm.get('lastName')?.hasError('minlength')">
              Minimum 2 characters required
            </mat-error>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline">
          <mat-label>Email Address</mat-label>
          <input matInput type="email" formControlName="email" autocomplete="email" />
          <mat-error *ngIf="userForm.get('email')?.hasError('required')">
            Email address is required
          </mat-error>
          <mat-error *ngIf="userForm.get('email')?.hasError('email')">
            Please enter a valid email address
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Phone Number</mat-label>
          <input matInput type="tel" formControlName="phone" autocomplete="tel" />
        </mat-form-field>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Role</mat-label>
            <mat-select formControlName="roleId">
              <mat-option *ngFor="let role of roles" [value]="role.id">
                {{ role.name }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="userForm.get('roleId')?.hasError('required')">
              Please choose a role for this user
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Site / Branch</mat-label>
            <mat-select formControlName="siteCode">
              <mat-option *ngFor="let site of sites" [value]="site.code">
                {{ site.name }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="userForm.get('siteCode')?.hasError('required')">
              Please choose a site
            </mat-error>
          </mat-form-field>
        </div>

        <button mat-raised-button color="primary" type="submit" [disabled]="isSubmitting">
          <mat-progress-spinner *ngIf="isSubmitting" diameter="20" mode="indeterminate"></mat-progress-spinner>
          <span *ngIf="!isSubmitting">Invite User</span>
        </button>
      </form>
    </mat-card>

    <mat-card class="table-card">
      <div class="table-header">
        <div>
          <h2 class="card-title">Team Members</h2>
          <p class="card-caption">Users listed here can access the system via Google login.</p>
        </div>
      </div>

      <ng-container *ngIf="!isLoadingUsers; else loadingBlock">
        <table mat-table class="user-table" [dataSource]="users" *ngIf="users?.length; else emptyState">
          <ng-container matColumnDef="user">
            <th mat-header-cell *matHeaderCellDef>User</th>
            <td mat-cell *matCellDef="let user">
              <div class="user-cell">
                <span class="user-name">{{ user.fullName || (user.firstName + ' ' + user.lastName) }}</span>
                <span class="user-email">{{ user.email }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="role">
            <th mat-header-cell *matHeaderCellDef>Role</th>
            <td mat-cell *matCellDef="let user">
              <mat-chip color="primary" selected>
                {{ getRoleDisplay(user) }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="site">
            <th mat-header-cell *matHeaderCellDef>Site</th>
            <td mat-cell *matCellDef="let user">
              {{ getSiteLabel(user) }}
            </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let user">
              <mat-chip [ngClass]="['status-chip', getStatus(user)]">
                {{ getStatus(user) | titlecase }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="lastLogin">
            <th mat-header-cell *matHeaderCellDef>Last Login</th>
            <td mat-cell *matCellDef="let user">
              {{ user.lastLoginAt ? (user.lastLoginAt | date: 'medium') : 'Never' }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackByUser"></tr>
        </table>
      </ng-container>

      <ng-template #loadingBlock>
        <div class="loading-block">
          <mat-progress-spinner diameter="36" mode="indeterminate"></mat-progress-spinner>
          <p>Loading users...</p>
        </div>
      </ng-template>

      <ng-template #emptyState>
        <div class="empty-state">
          <mat-icon>group_add</mat-icon>
          <p>No users found. Invite your first team member to get started.</p>
        </div>
      </ng-template>
    </mat-card>
  </div>
</div>